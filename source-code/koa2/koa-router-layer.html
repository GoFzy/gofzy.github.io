<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa2路由中间件--koa-router(1) | GoFzy</title>
    <meta name="description" content="脚踏实地，仰望星空">
    <link rel="icon" href="/F.png">
    
    <link rel="preload" href="/assets/css/0.styles.1b9f5e10.css" as="style"><link rel="preload" href="/assets/js/app.e2a0bc12.js" as="script"><link rel="preload" href="/assets/js/2.ffc85a67.js" as="script"><link rel="preload" href="/assets/js/31.3f22bf3e.js" as="script"><link rel="prefetch" href="/assets/js/10.16eab02a.js"><link rel="prefetch" href="/assets/js/11.bf5ec133.js"><link rel="prefetch" href="/assets/js/12.221b6f67.js"><link rel="prefetch" href="/assets/js/13.c6e69e20.js"><link rel="prefetch" href="/assets/js/14.99a9d455.js"><link rel="prefetch" href="/assets/js/15.3a284737.js"><link rel="prefetch" href="/assets/js/16.79d64dc1.js"><link rel="prefetch" href="/assets/js/17.5e406ce6.js"><link rel="prefetch" href="/assets/js/18.b72926f6.js"><link rel="prefetch" href="/assets/js/19.61fc4542.js"><link rel="prefetch" href="/assets/js/20.3db0d9bc.js"><link rel="prefetch" href="/assets/js/21.f4c1528d.js"><link rel="prefetch" href="/assets/js/22.3a481cb5.js"><link rel="prefetch" href="/assets/js/23.cdee567e.js"><link rel="prefetch" href="/assets/js/24.856be0b9.js"><link rel="prefetch" href="/assets/js/25.df567523.js"><link rel="prefetch" href="/assets/js/26.08fc6653.js"><link rel="prefetch" href="/assets/js/27.1b4e7bc2.js"><link rel="prefetch" href="/assets/js/28.a8b8135e.js"><link rel="prefetch" href="/assets/js/29.7b17ab5a.js"><link rel="prefetch" href="/assets/js/3.dc5d0d43.js"><link rel="prefetch" href="/assets/js/30.dd840729.js"><link rel="prefetch" href="/assets/js/32.998c6ce0.js"><link rel="prefetch" href="/assets/js/33.75bd15bf.js"><link rel="prefetch" href="/assets/js/34.bcb04044.js"><link rel="prefetch" href="/assets/js/35.2494bca3.js"><link rel="prefetch" href="/assets/js/36.cd36c95a.js"><link rel="prefetch" href="/assets/js/37.f13bf26a.js"><link rel="prefetch" href="/assets/js/38.b19352c9.js"><link rel="prefetch" href="/assets/js/39.3c848e8d.js"><link rel="prefetch" href="/assets/js/4.c516a99f.js"><link rel="prefetch" href="/assets/js/40.4ead735b.js"><link rel="prefetch" href="/assets/js/41.dde15470.js"><link rel="prefetch" href="/assets/js/5.28430339.js"><link rel="prefetch" href="/assets/js/6.206f7f91.js"><link rel="prefetch" href="/assets/js/7.f065ebd0.js"><link rel="prefetch" href="/assets/js/8.6c06ae76.js"><link rel="prefetch" href="/assets/js/9.32855513.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b9f5e10.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">GoFzy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/about-me/" class="nav-link">个人介绍</a></div><div class="nav-item"><a href="/front-end/" class="nav-link">知识体系</a></div><div class="nav-item"><a href="/source-code/" class="nav-link router-link-active">源码学习</a></div><div class="nav-item"><a href="/reading/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="https://github.com/GoFzy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/about-me/" class="nav-link">个人介绍</a></div><div class="nav-item"><a href="/front-end/" class="nav-link">知识体系</a></div><div class="nav-item"><a href="/source-code/" class="nav-link router-link-active">源码学习</a></div><div class="nav-item"><a href="/reading/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="https://github.com/GoFzy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/source-code/koa2/" class="sidebar-link">Koa2源码学习目录</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/source-code/koa2/application.html" class="sidebar-link">1. 框架入口application</a></li><li><a href="/source-code/koa2/koa-compose.html" class="sidebar-link">2. koa-compose 中间件机制</a></li><li><a href="/source-code/koa2/koa-router-layer.html" class="active sidebar-link">3. koa-router 路由模块(1)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-layer.html#layer" class="sidebar-link">Layer</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-layer.html#params-参数的捕获" class="sidebar-link">params 参数的捕获</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-layer.html#单个param处理函数" class="sidebar-link">单个param处理函数</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-layer.html#setprefix路由前缀" class="sidebar-link">setPrefix路由前缀</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-layer.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/source-code/koa2/koa-router-router.html" class="sidebar-link">4. koa-router 路由模块(2)</a></li><li><a href="/source-code/" class="sidebar-link">返回上一级</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa2路由中间件-koa-router-1"><a href="#koa2路由中间件-koa-router-1" aria-hidden="true" class="header-anchor">#</a> koa2路由中间件--koa-router(1)</h1> <p>关于 <code>koa-router</code> 的基本使用可以看我 <code>GitHub</code> 上的 <a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <code>koa-router</code> 的源码只有两个文件：<code>router.js</code> 和 <code>layer.js</code>，分别对应 <code>Router</code> 对象和 <code>Layer</code> 对象</p> <ul><li><code>Layer</code> 对象是对单个路由的管理，其中包含的信息有路由路径(<code>path</code>)、路由请求方法(<code>method</code>)和路由执行函数(<code>middleware</code>)，并且提供路由的验证以及 <code>params</code> 参数解析的方法</li> <li><code>Router</code> 对象则是对所有注册路由的统一处理，并且它的 <code>API</code> 是面向开发者的</li></ul> <p>在分析源码之前我们先看一下代码的结构图:
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/koa-router.png" alt="koa-router"></p> <h2 id="layer"><a href="#layer" aria-hidden="true" class="header-anchor">#</a> Layer</h2> <p><code>Layer</code> 对象主要是对单个路由的管理，是整个 <code>koa-router</code> 中最小的处理单元，后续模块的处理都离不开 <code>Layer</code> 中的方法，这正是首先介绍 <code>Layer</code> 的重要原因<br>
首先我们进入 <code>node_modules/_koa-router@7.4.0@koa-router/lib/layer.js</code> 文件，在这里创建了一个实例对象用于管理每个路由:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Layer</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 支持路由别名</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 路由对象的方法</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 路由参数名数组</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>paramNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 将路由执行函数保存在stack中，支持输入多个处理函数</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token operator">?</span> middleware <span class="token punctuation">:</span> <span class="token punctuation">[</span>middleware<span class="token punctuation">]</span><span class="token punctuation">;</span>
  methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// HEAD请求头部信息与GET一致，这里就一起处理了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">[</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token string">'HEAD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 确保中间件类型正确</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> type <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        methods<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; `&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>name <span class="token operator">||</span> path<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;`: `middleware` &quot;</span>
        <span class="token operator">+</span> <span class="token string">&quot;must be a function, not `&quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot;`&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token comment">// 1、根据路由路径生成路由正则表达式</span>
  <span class="token comment">// 2、将params参数信息保存在paramNames数组中</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>regexp <span class="token operator">=</span> <span class="token function">pathToRegExp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'defined route %s %s'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到 <code>Layer</code> 构造函数主要用来初始化</p> <ul><li>路由路径并转化为正则表达式 ------------------ <code>this.path &amp; this.regexp</code></li> <li>路由请求方法数组 ------------------------------- <code>this.methods</code></li> <li>路由处理函数数组 ------------------------------- <code>this.stack</code></li> <li><code>params</code> 参数信息数组 -------------------------- <code>this.paramNames</code></li></ul> <p>其中主要采用<strong>pathToRegexp</strong>方法根据路径字符串生成正则表达式，通过该正则表达式，可以实现路由的匹配</p> <h2 id="params-参数的捕获"><a href="#params-参数的捕获" aria-hidden="true" class="header-anchor">#</a> params 参数的捕获</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 验证路由</span>
<span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">match</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 捕获params参数</span>
<span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">captures</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>ignoreCaptures<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>regexp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据 <code>paramNames</code> 中的参数信息以及 <code>captrues</code> 方法，可以获取到当前路由 <code>params</code> 参数的键值对：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">params</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> captures<span class="token punctuation">,</span> existingParams</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> params <span class="token operator">=</span> existingParams <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> len <span class="token operator">=</span> captures<span class="token punctuation">.</span>length<span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> c <span class="token operator">=</span> captures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      params<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> c <span class="token operator">?</span> <span class="token function">safeDecodeURIComponent</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">:</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> params<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>关于 <code>params</code> 参数，它最终会通过 <code>router</code> 实例对象挂载至 <code>ctx</code> 对象的上，并可以通过 <code>ctx.params</code> 访问，以<a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为例，在 <code>./routes/dynamic.js</code> 中通过 <code>params</code> 参数配置了动态路由：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./routes/dynamic.js</span>
<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'koa-router'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id/:aid'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前访问参数</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>
</code></pre></div><p>启动服务后，我们访问 <code>localhost:3000/dynamic/hello/world</code> 就可以打印出 <code>params</code> 参数
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/koa-router-layer-params.jpg" alt="koa-router-layer-params"><br>
关于 <code>Layer</code> 的原型方法 <code>params</code> 是如何挂载到 <code>router</code> 实例对象上，可以在 <code>koa-router/router.js</code>的 <code>Router.prototype.routes</code>方法中详细阅读</p> <h2 id="单个param处理函数"><a href="#单个param处理函数" aria-hidden="true" class="header-anchor">#</a> 单个param处理函数</h2> <p>这是最终挂载在 <code>router</code> 实例上的方法，如何使用在官网上 <code>koa-router api</code> 中 <code>param</code> 方法有<a href="https://www.npmjs.com/package/koa-router#module_koa-router--Router+param" target="_blank" rel="noopener noreferrer">介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，但是讲得比较抽象，这里通过源码分析，希望能让大家更好的理解<br> <strong>使用</strong>:个人理解，所谓 <code>param</code> 方法就是为某个动态参数添加中间件函数，并按位置顺序执行，同样还是以<a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为例，我为之前在 <code>./routes/dynamic.js</code> 中配置的两个动态路由参数添加了相应的中间件函数:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./routes/dynamic.js</span>
<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'koa-router'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router
  <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'id大于4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'aid'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">aid<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>aid<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aid大于4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id/:aid'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前访问参数</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>
</code></pre></div><p>现在大家分别访问 <code>localhost:3000/dynamic/hi/world</code> 和 <code>localhost:3000/dynamic/hello/wor</code>，就可以在 <code>vscode</code> 控制台中看到不同的输出，这就是 <code>param api</code> 的基本使用</p> <p><strong>源码</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">param</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> stack <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
  <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">;</span>

  <span class="token comment">// 根据传入的param 和 fn 创建中间件函数</span>
  <span class="token keyword">var</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 中间件与对应的参数进行绑定</span>
  middleware<span class="token punctuation">.</span>param <span class="token operator">=</span> param<span class="token punctuation">;</span>

  <span class="token comment">// 获取所有动态路由参数</span>
  <span class="token keyword">var</span> names <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 找到param在动态路由参数中的位置</span>
  <span class="token keyword">var</span> x <span class="token operator">=</span> names<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stack<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">.</span>param <span class="token operator">||</span> names<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">.</span>param<span class="token punctuation">)</span> <span class="token operator">&gt;</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将单个param前置处理函数插入正确的位置</span>
        stack<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 跳出循环</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上述代码中通过some方法寻找单个 <code>param</code> 处理函数的原因在于以下两点：</p> <ul><li>保持 <code>param</code> 处理函数位于其他路由处理函数的前面；</li> <li>路由中存在多个 <code>param</code> 参数，需要保持 <code>param</code> 处理函数的前后顺序。</li></ul> <h2 id="setprefix路由前缀"><a href="#setprefix路由前缀" aria-hidden="true" class="header-anchor">#</a> setPrefix路由前缀</h2> <p>这同样也是最终挂载在 <code>router</code> 实例上的方法，官网上 <code>koa-router api</code> 中 <code>predix</code> <a href="https://www.npmjs.com/package/koa-router#module_koa-router--Router+prefix" target="_blank" rel="noopener noreferrer">介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，同样我还是认为讲得不够详细，所以还是拿出来分析一下</p> <p><strong>使用</strong>：个人理解，该 <code>api</code> 作用就是将路由<strong>相同的前缀</strong>提取出来，同样还是以<a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为例，我在 <code>./routes/prefix.js</code> 中设置 <code>/koa</code> 为路由前缀部分:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">'koa-router'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 上述方法等价于
 * const router = new Router({
 *     prefix: '/koa'
 * })
 */</span>

<span class="token comment">// 等同于&quot;localhost/prefix/koa/:id&quot;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">koa router prefix </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于&quot;localhost/prefix/koa&quot;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'koa router prefix'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router<span class="token punctuation">;</span>
</code></pre></div><p><strong>源码</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setPrefix</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> prefix <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span> <span class="token comment">// 拼接新的路由路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>paramNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据新的路由路径字符串生成正则表达式</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>regexp <span class="token operator">=</span> <span class="token function">pathToRegExp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramNames<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>由此可见 <code>Layer</code> 中的 <code>setPrefix</code> 方法用于设置路由路径的前缀，这在嵌套路由的实现中尤其重要。</p> <h2 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h2> <p>最后小结一下，整体而言在 <code>layer.js</code> 文件中代码还算易懂，以下几个是比较重要的属性与方法
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/koa-router-layer.jpg" alt="koa-router-layer"></p> <p>参考文章：</p> <ul><li><a href="https://github.com/zhangxiang958/zhangxiang958.github.io/issues/38" target="_blank" rel="noopener noreferrer">https://github.com/zhangxiang958/zhangxiang958.github.io/issues/38<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5c24c3b9e51d45538150f3ab#heading-8" target="_blank" rel="noopener noreferrer">https://juejin.im/post/5c24c3b9e51d45538150f3ab#heading-8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/dwqs/blog/issues/8" target="_blank" rel="noopener noreferrer">https://github.com/dwqs/blog/issues/8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于：: </span> <span class="time">9/5/2019, 9:55:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/source-code/koa2/koa-compose.html" class="prev">
          2. koa-compose 中间件机制
        </a></span> <span class="next"><a href="/source-code/koa2/koa-router-router.html">
          4. koa-router 路由模块(2)
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e2a0bc12.js" defer></script><script src="/assets/js/2.ffc85a67.js" defer></script><script src="/assets/js/31.3f22bf3e.js" defer></script>
  </body>
</html>

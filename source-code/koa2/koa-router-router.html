<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa2路由中间件--koa-router(2) | GoFzy</title>
    <meta name="description" content="脚踏实地，仰望星空">
    <link rel="icon" href="/F.png">
    
    <link rel="preload" href="/assets/css/0.styles.1b9f5e10.css" as="style"><link rel="preload" href="/assets/js/app.e2a0bc12.js" as="script"><link rel="preload" href="/assets/js/2.ffc85a67.js" as="script"><link rel="preload" href="/assets/js/32.998c6ce0.js" as="script"><link rel="prefetch" href="/assets/js/10.16eab02a.js"><link rel="prefetch" href="/assets/js/11.bf5ec133.js"><link rel="prefetch" href="/assets/js/12.221b6f67.js"><link rel="prefetch" href="/assets/js/13.c6e69e20.js"><link rel="prefetch" href="/assets/js/14.99a9d455.js"><link rel="prefetch" href="/assets/js/15.3a284737.js"><link rel="prefetch" href="/assets/js/16.79d64dc1.js"><link rel="prefetch" href="/assets/js/17.5e406ce6.js"><link rel="prefetch" href="/assets/js/18.b72926f6.js"><link rel="prefetch" href="/assets/js/19.61fc4542.js"><link rel="prefetch" href="/assets/js/20.3db0d9bc.js"><link rel="prefetch" href="/assets/js/21.f4c1528d.js"><link rel="prefetch" href="/assets/js/22.3a481cb5.js"><link rel="prefetch" href="/assets/js/23.cdee567e.js"><link rel="prefetch" href="/assets/js/24.856be0b9.js"><link rel="prefetch" href="/assets/js/25.df567523.js"><link rel="prefetch" href="/assets/js/26.08fc6653.js"><link rel="prefetch" href="/assets/js/27.1b4e7bc2.js"><link rel="prefetch" href="/assets/js/28.a8b8135e.js"><link rel="prefetch" href="/assets/js/29.7b17ab5a.js"><link rel="prefetch" href="/assets/js/3.dc5d0d43.js"><link rel="prefetch" href="/assets/js/30.dd840729.js"><link rel="prefetch" href="/assets/js/31.3f22bf3e.js"><link rel="prefetch" href="/assets/js/33.75bd15bf.js"><link rel="prefetch" href="/assets/js/34.bcb04044.js"><link rel="prefetch" href="/assets/js/35.2494bca3.js"><link rel="prefetch" href="/assets/js/36.cd36c95a.js"><link rel="prefetch" href="/assets/js/37.f13bf26a.js"><link rel="prefetch" href="/assets/js/38.b19352c9.js"><link rel="prefetch" href="/assets/js/39.3c848e8d.js"><link rel="prefetch" href="/assets/js/4.c516a99f.js"><link rel="prefetch" href="/assets/js/40.4ead735b.js"><link rel="prefetch" href="/assets/js/41.dde15470.js"><link rel="prefetch" href="/assets/js/5.28430339.js"><link rel="prefetch" href="/assets/js/6.206f7f91.js"><link rel="prefetch" href="/assets/js/7.f065ebd0.js"><link rel="prefetch" href="/assets/js/8.6c06ae76.js"><link rel="prefetch" href="/assets/js/9.32855513.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1b9f5e10.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">GoFzy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/about-me/" class="nav-link">个人介绍</a></div><div class="nav-item"><a href="/front-end/" class="nav-link">知识体系</a></div><div class="nav-item"><a href="/source-code/" class="nav-link router-link-active">源码学习</a></div><div class="nav-item"><a href="/reading/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="https://github.com/GoFzy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/about-me/" class="nav-link">个人介绍</a></div><div class="nav-item"><a href="/front-end/" class="nav-link">知识体系</a></div><div class="nav-item"><a href="/source-code/" class="nav-link router-link-active">源码学习</a></div><div class="nav-item"><a href="/reading/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="https://github.com/GoFzy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/source-code/koa2/" class="sidebar-link">Koa2源码学习目录</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/source-code/koa2/application.html" class="sidebar-link">1. 框架入口application</a></li><li><a href="/source-code/koa2/koa-compose.html" class="sidebar-link">2. koa-compose 中间件机制</a></li><li><a href="/source-code/koa2/koa-router-layer.html" class="sidebar-link">3. koa-router 路由模块(1)</a></li><li><a href="/source-code/koa2/koa-router-router.html" class="active sidebar-link">4. koa-router 路由模块(2)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#router" class="sidebar-link">Router</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#http-methods" class="sidebar-link">http methods</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#router-prototype-register" class="sidebar-link">Router.prototype.register</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#router-prototype-match" class="sidebar-link">Router.prototype.match</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#router-prototype-routes" class="sidebar-link">Router.prototype.routes</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#router-prototype-use" class="sidebar-link">Router.prototype.use</a></li><li class="sidebar-sub-header"><a href="/source-code/koa2/koa-router-router.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/source-code/" class="sidebar-link">返回上一级</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa2路由中间件-koa-router-2"><a href="#koa2路由中间件-koa-router-2" aria-hidden="true" class="header-anchor">#</a> koa2路由中间件--koa-router(2)</h1> <h2 id="router"><a href="#router" aria-hidden="true" class="header-anchor">#</a> Router</h2> <p>上一篇文章中我们已经介绍过 <code>layer.js</code> 文件。接下来，我们进入 <code>node_modules/_koa-router@7.4.0@koa-router/lib/router.js</code> 文件，在这里首先定义了 <code>Router</code> 构造函数:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>methods <span class="token operator">||</span> <span class="token punctuation">[</span>
    <span class="token string">'HEAD'</span><span class="token punctuation">,</span>
    <span class="token string">'OPTIONS'</span><span class="token punctuation">,</span>
    <span class="token string">'GET'</span><span class="token punctuation">,</span>
    <span class="token string">'PUT'</span><span class="token punctuation">,</span>
    <span class="token string">'PATCH'</span><span class="token punctuation">,</span>
    <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token string">'DELETE'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到, 实际有用的属性不过 3 个, 分别是 <code>methods</code> 数组, <code>params</code> 对象, <code>stack</code> 数组:</p> <ul><li><code>methods</code> 数组存放的是允许使用的 <code>HTTP</code> 方法名, 会在 <code>Router.prototype.allowedMethods</code> 方法中使用, 我们在创建 <code>Router</code> 实例的时候可以进行配置, 允许使用哪些方法</li> <li><code>params</code> 保存 <code>param</code> 前置处理函数，格式为<code>{ param: 中间件函数 }</code></li> <li><code>stack</code> 数组, 则是存储每一个路由, 也就是 <code>Layer</code> 的实例对象, 每一个路由都相当于一个 <code>Layer</code> 实例对象</li></ul> <p><code>Layer</code> 中的 <code>stack</code> 和 <code>Router</code> 中的 <code>stack</code> 是<strong>不一样的</strong>:</p> <ul><li><code>Router</code> 的 <code>stack</code> 数组是存放每个路由对应的 <code>Layer</code> 实例对象的</li> <li><code>Layer</code> 实例对象里面的 <code>stack</code> 数组是存储每个路由的处理函数中间件的, 换言之, 一个路由可以添加多个处理函数
两者关系如下图所示:
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/koa-router-stack.png" alt="koa-router-stack"></li></ul> <h2 id="http-methods"><a href="#http-methods" aria-hidden="true" class="header-anchor">#</a> http methods</h2> <p>源码中采用 <code>methods</code> 模块获取 <code>HTTP</code> 请求方法名，该模块内部实现主要依赖于 <code>http</code> 模块</p> <div class="language-js extra-class"><pre class="language-js"><code>http<span class="token punctuation">.</span><span class="token constant">METHODS</span> <span class="token operator">&amp;&amp;</span> http<span class="token punctuation">.</span><span class="token constant">METHODS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">lowerCaseMethod</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在 <code>koa-router</code> 里面的体现就是我们可以通过在 <code>router</code> 实例对象上调用对应的方法函数来注册对应的 <code>HTTP</code> 方法的路由，同时将<strong>传入的路由路径</strong>与对应的<strong>回调函数</strong>绑定, 所以我们可以遍历一个方法数组来快速构建原型的 <code>method</code> 方法:</p> <div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> middleware<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> path <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      path <span class="token operator">=</span> name<span class="token punctuation">;</span>
      name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面函数中</p> <ul><li>先判断 <code>path</code> 是否是字符串或者正则表达式是因为注册路由的时候还可以为路由进行命名(命名空间方便管理)</li> <li>然后准确地获取回调的函数数组(注册路由可以接收多个回调), 这样如果匹配到某个路由, 回调函数数组中的函数就会依次执行. 留意到每个方法都会返回对象本身, 也就是说注册路由的时候是可以支持<strong>链式</strong>调用的</li></ul> <p>以<a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为例，我们对其进行调试就能更好的理解上述过程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./routes/home.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'最小系统注册'</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">'首页'</span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token string">'Koa2 最小系统的首页'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ./routes/admin.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'admin注册'</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">koa-demo</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前访问路径:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>host <span class="token operator">+</span> ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'/users注册'</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token function">userAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">koa-demo</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    body<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前访问路径:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>host <span class="token operator">+</span> ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// node_modules/_koa-router@7.4.0@koa-router/lib/router.js</span>
methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> middleware<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'在这里注册'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> path <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      path <span class="token operator">=</span> name<span class="token punctuation">;</span>
      name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行结果如下:<br> <img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/router.method.jpg" alt="router-method"><br>
可以看到每次注册路由时，都是调用了 <code>Router.prototype[某个method]</code>，不过真正注册路由的核心方法还是 <code>register</code> 函数，所以我们下面看看 <code>register</code> 函数的逻辑</p> <h2 id="router-prototype-register"><a href="#router-prototype-register" aria-hidden="true" class="header-anchor">#</a> Router.prototype.register</h2> <p><code>register</code> 是注册路由的核心函数, 举个例子, 如果我们需要注册一个路径为 <code>'/test'</code> 的接收 <code>GET</code> 方法的路由, 那么:</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其实它相当于下面这段代码:</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以看到,函数</p> <ul><li>第一个参数是<strong>路由</strong></li> <li>第二个参数是<strong>方法名放入到方法数组中</strong></li> <li>第三个函数是<strong>路由的回调数组</strong>, 其实每个路由注册的时候, 后面都可以添加很多个函数, 而这些函数都会被添加到一个数组里面, 如果被匹配到, 就会利用中间件机制来逐个执行这些函数</li> <li>最后一个参数是<strong>路由的命名空间</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> stack <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>

  <span class="token comment">// 注册路由中间件时，允许path为数组</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      router<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> p<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 实例化Layer</span>
  <span class="token keyword">var</span> route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    end<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>end <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> opts<span class="token punctuation">.</span>end <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    sensitive<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>sensitive <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>sensitive <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    strict<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>strict <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>strict <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    prefix<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>prefix <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    ignoreCaptures<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>ignoreCaptures
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置前缀</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span><span class="token function">setPrefix</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置param前置处理函数</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> route<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>register</code> 方法主要负责实例化 <code>Layer</code> 对象、更新路由前缀和 <code>param</code> 处理函数，这些操作在上篇文章 <a href="http://gofzy.com/source-code/koa2/koa-router-layer.html" target="_blank" rel="noopener noreferrer"><code>Layer</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中有详细介绍</p> <h2 id="router-prototype-match"><a href="#router-prototype-match" aria-hidden="true" class="header-anchor">#</a> Router.prototype.match</h2> <p>通过上面的模块, 我们已经注册好了路由, 但是, 如果请求过来了, 请求是怎么匹配然后进行到相对应的处理函数去的呢? 答案就是利用 <code>match</code> 函数.先看一下 <code>match</code> 函数的代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">match</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取所有路由 Layer 实例</span>
  <span class="token keyword">var</span> layers <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
  <span class="token keyword">var</span> layer<span class="token punctuation">;</span>
  <span class="token comment">// 匹配结果</span>
  <span class="token keyword">var</span> matched <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pathAndMethod<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    route<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 遍历路由 Router 的 stack 逐个判断</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> len <span class="token operator">=</span> layers<span class="token punctuation">.</span>length<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    layer <span class="token operator">=</span> layers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'test %s %s'</span><span class="token punctuation">,</span> layer<span class="token punctuation">.</span>path<span class="token punctuation">,</span> layer<span class="token punctuation">.</span>regexp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 利用 Layer.prototype.match 方法匹配路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将对应的 Layer 实例加入到结果集的 path 数组中</span>
      matched<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果对应的 layer 实例中 methods 数组为空或者数组中有找到对应的方法</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">~</span>layer<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将 layer 放入到结果集的 pathAndMethod 中</span>
        matched<span class="token punctuation">.</span>pathAndMethod<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里是用于判断是否有真正匹配到路由处理函数</span>
        <span class="token comment">// 因为像 router.use(session()); 这样的中间件也是通过 Layer 来管理的, 它们的 methods 数组为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>methods<span class="token punctuation">.</span>length<span class="token punctuation">)</span> matched<span class="token punctuation">.</span>route <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> matched<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过上面返回的结果集, 我们知道一个请求来临的时候, 我们可以使用正则来匹配路由是否符合, 然后在 <code>path</code> 数组或者 <code>pathAndMethod</code> 数组中找到对应的 <code>Layer</code> 实例对象</p> <h2 id="router-prototype-routes"><a href="#router-prototype-routes" aria-hidden="true" class="header-anchor">#</a> Router.prototype.routes</h2> <p><a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，我在 <code>./routes</code> 路由文件中注册好了路由之后, 就可以使用 <code>router.routes</code> 来将路由模块添加到 <code>koa</code> 的中间件处理机制当中了。由于 <code>koa</code> 的中间件插件是以一个函数的形式存在的, 所以 <code>routes</code> 函数返回值就是一个函数:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  dispatch<span class="token punctuation">.</span>router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> dispatch<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以看到返回的 <code>dispatch</code> 函数在 <code>routes</code> 内部形成了一个闭包, 并且按照 <code>koa</code> 的中间件形式编写函数.对于 <code>dispatch</code> 函数内部逻辑就如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'%s %s'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">var</span> path <span class="token operator">=</span> router<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>routerPath <span class="token operator">||</span> ctx<span class="token punctuation">.</span>routerPath <span class="token operator">||</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token comment">// 根据 path 值匹配到路由 Layer 实例对象</span>
    <span class="token keyword">var</span> matched <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> layerChain<span class="token punctuation">,</span> layer<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>matched<span class="token punctuation">,</span> matched<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>matched <span class="token operator">=</span> matched<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    ctx<span class="token punctuation">.</span>router <span class="token operator">=</span> router<span class="token punctuation">;</span>
    <span class="token comment">// 如果没有匹配到对应的路由模块,会认为时全局路由中间件， 那么此处就直接跳过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matched<span class="token punctuation">.</span>route<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 取路径与方法都匹配了的 Layer 实例对象</span>
    <span class="token keyword">var</span> matchedLayers <span class="token operator">=</span> matched<span class="token punctuation">.</span>pathAndMethod
    <span class="token keyword">var</span> mostSpecificLayer <span class="token operator">=</span> matchedLayers<span class="token punctuation">[</span>matchedLayers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    ctx<span class="token punctuation">.</span>_matchedRoute <span class="token operator">=</span> mostSpecificLayer<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mostSpecificLayer<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>_matchedRouteName <span class="token operator">=</span> mostSpecificLayer<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 构建路径对应路由的处理中间件函数数组</span>
    <span class="token comment">// 这里的目的是在每个匹配的路由对应的中间件处理函数数组前添加一个用于处理</span>
    <span class="token comment">// 对应路由的 captures, params, 以及路由命名的函数</span>
    layerChain <span class="token operator">=</span> matchedLayers<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> layer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      memo<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// captures 是存储路由中参数的值的数组</span>
        ctx<span class="token punctuation">.</span>captures <span class="token operator">=</span> layer<span class="token punctuation">.</span><span class="token function">captures</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>captures<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// params 是一个对象, 键为参数名, 根据参数名可以获取路由中的参数值, 值从 captures 中拿</span>
        ctx<span class="token punctuation">.</span>params <span class="token operator">=</span> layer<span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>captures<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>routerName <span class="token operator">=</span> layer<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>layer<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 compose 模块将对应路由的处理中间件数组中的函数逐个执行</span>
    <span class="token comment">// 当路由的处理函数中间件函数全部执行完, 再调用上一层级的 next 函数进入下一个中间件</span>
    <span class="token keyword">return</span> <span class="token function">compose</span><span class="token punctuation">(</span>layerChain<span class="token punctuation">)</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="router-prototype-use"><a href="#router-prototype-use" aria-hidden="true" class="header-anchor">#</a> Router.prototype.use</h2> <p>熟悉 <code>Koa</code> 的同学都知道 <code>use</code> 是用来注册中间件的方法，相比较 <code>Koa</code> 中的全局中间件，<code>koa-router</code> 的中间件则是路由级别的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 中间件函数数组</span>
  <span class="token keyword">var</span> middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> path<span class="token punctuation">;</span>

  <span class="token comment">// 支持同时为多个路由绑定中间件函数: router.use(['/use', '/admin'], auth());</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>middleware<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> middleware<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    middleware<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 递归调用</span>
      router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> <span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/// 如果第一个参数有传值为字符串, 说明有传路径</span>
  <span class="token keyword">var</span> hasPath <span class="token operator">=</span> <span class="token keyword">typeof</span> middleware<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path <span class="token operator">=</span> middleware<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  middleware<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果有 router 属性, 说明这个中间件函数是由 Router.prototype.routes 暴露出来的 属于嵌套路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是嵌套路由, 相当于将需要嵌套路由重新注册到现在的 Router 对象上</span>
      m<span class="token punctuation">.</span>router<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">nestedLayer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有 path, 那么为需要嵌套的路由加上路径前缀</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> nestedLayer<span class="token punctuation">.</span><span class="token function">setPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果本身的 router 有前缀配置, 也添加上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span> nestedLayer<span class="token punctuation">.</span><span class="token function">setPrefix</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将需要嵌套的路由模块的 stack 中存储的 Layer 加入到本 router 对象上</span>
        router<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>nestedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

      <span class="token comment">// 不要忘记将父路由上的param前置处理操作 更新到新路由上。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          m<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> router<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有 router 属性则是常规中间件函数, 如果有给定的 path 那么就生成一个 Layer 模块进行管理</span>
      router<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path <span class="token operator">||</span> <span class="token string">'(.*)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">{</span> end<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ignoreCaptures<span class="token punctuation">:</span> <span class="token operator">!</span>hasPath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>讲到这里，大家可能被上面的 <code>match</code>、<code>use</code> 以及 <code>routes</code> 方法绕晕了，接下来我们以<a href="https://github.com/GoFzy/Koa2-demo" target="_blank" rel="noopener noreferrer"><code>Koa2</code> 最小系统项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>为例，对上述流程进行梳理:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">import</span> prefix <span class="token keyword">from</span> <span class="token string">'./routes/prefix'</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/prefix'</span><span class="token punctuation">,</span> prefix<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>系统中在 <code>./app.js</code> 文件中配置 <code>/prefix</code> 层级路由，接下来我们在 <code>node_modules/_koa-router@7.4.0@koa-router/lib/router.js</code> 中<code>routes</code>、<code>use</code> 以及 <code>match</code> 这三个原型方法中打下断点，然后<code>f5</code> 启动 <code>debug</code><br> <strong>第一个断点</strong>： 我们可以看到服务启动后，首先进入了 <code>Router.prototype.routes</code> 方法当中，在这里返回了 <code>dispatch</code> 函数:
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/router.prototype.routes.jpg" alt="router.prototype.routes"><br>
此时，原 <code>app.js</code> 文件中就等价于</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/prefix'</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>第二个断点</strong>： 继续向下就来到了第二个断点，也就是 <code>Router.prototype.use</code> 方法当中，
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/router.prototype.use.jpg" alt="router.prototype.use"><br>
需要注意的是，此时的 <code>this</code> 指向的是 <code>app.js</code> 中的 <code>router</code> 实例对象。这个方法上面讲解过，就是将中间件函数与对应的路由绑定起来</p> <p><strong>第三个断点</strong>： 在第二个断点结束后，其实不会马上进入第三个断点，因为 <code>match</code> 方法是匹配请求的，因此我们需要发起一个请求-- <code>localhost:3000/prefix/koa/hello</code> <img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/router.prototype.match.jpg" alt="router.prototype.match"><br>
之前提到过，在调用 <code>Router.prototype.routes</code> 方法之后 <code>app.js</code> 等价于</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/prefix'</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>因此请求进来时</p> <ul><li>先执行这个 <code>dispatch</code> 中间件函数</li> <li>然后通过 <code>dispatch</code> 进入到 <code>Router.prototype.match</code> 方法中找到对应的路由 <code>Layer</code> 实例对象</li> <li>找到后回到 <code>dispatch</code> 函数，通过 <code>koa-compose</code> 按洋葱模型机制执行所有中间件函数</li></ul> <h2 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h2> <p>本篇文章主要可以分为两部分: <strong>路由的注册</strong> 和 <strong>路由的匹配</strong></p> <ul><li>路由的注册比较简单，主要使用了两个方法 <code>Router.prototype[method]</code> 和 <code>Router.prototype.register</code></li> <li>路由的匹配相对比较复杂，这里以一张流程图进行总结
<img src="https://raw.githubusercontent.com/GoFzy/pic-bed/master/koa-router-match.png" alt="koa-router-match"></li></ul> <p>参考文章</p> <ul><li><a href="https://juejin.im/post/5c24c3b9e51d45538150f3ab" target="_blank" rel="noopener noreferrer">https://juejin.im/post/5c24c3b9e51d45538150f3ab<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/zhangxiang958/zhangxiang958.github.io/issues/38" target="_blank" rel="noopener noreferrer">https://github.com/zhangxiang958/zhangxiang958.github.io/issues/38<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新于：: </span> <span class="time">8/12/2019, 4:25:18 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/source-code/koa2/koa-router-layer.html" class="prev">
          3. koa-router 路由模块(1)
        </a></span> <span class="next"><a href="/source-code/" class="router-link-active">
          返回上一级
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e2a0bc12.js" defer></script><script src="/assets/js/2.ffc85a67.js" defer></script><script src="/assets/js/32.998c6ce0.js" defer></script>
  </body>
</html>
